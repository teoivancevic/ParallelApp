@page "/excel"
@using System.Text.RegularExpressions
@using OfficeOpenXml
@using NPOI.XSSF.UserModel;
@using NPOI.SS.UserModel;
@using System.Data

<h1>TestExcel</h1>

<InputFile id="fileInput" OnChange="UploadFiles" hidden accept=".xlsx"/>

<MudButton HtmlTag="label"
           Variant="Variant.Filled"
           Color="Color.Primary"
           StartIcon="@Icons.Filled.CloudUpload"
           for="fileInput">
    Upload Files
</MudButton>

    <table class="table">
        <thead>
            <tr>
                @foreach(DataColumn col in dt.Columns)
                {
                    <th>@col.ColumnName</th>    
                }
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in dt.Rows)
            {
                <tr>
                    @foreach(DataColumn col in dt.Columns)
                    {
                        <td>@row[col.ColumnName].ToString()</td>
                    }
                </tr>
            }
        </tbody>
    </table>






@code {

    DataTable dt = new DataTable();

    private async void UploadFiles(InputFileChangeEventArgs e)
    {

        //MISLIM DA JE OVO SAVRSENO: https://www.youtube.com/watch?v=4UAgSfgWbVE 

        var file = e.File;  


        Stream stream = e.File.OpenReadStream();
        MemoryStream ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        stream.Close();

        ms.Position = 0;

        ISheet sheet;
        var xsswb = new XSSFWorkbook(ms);

        sheet = xsswb.GetSheetAt(0);
        IRow hr = sheet.GetRow(0);
        var rowList = new List<string>();

        int cellCount = hr.LastCellNum;
        for (var i = 0; i < cellCount; i++)
        {
            ICell cell = hr.GetCell(i);
            dt.Columns.Add(cell.ToString());
        }

        for (var i = (sheet.FirstRowNum + 1); i < (sheet.LastRowNum + 1); i++)
        {
            var row = sheet.GetRow(i);
            for (var j = row.FirstCellNum; j < cellCount; j++)
            {
                rowList.Add(row.GetCell(j).ToString());
            }

            if(rowList.Count > 0)
            {
                dt.Rows.Add(rowList.ToArray());
            }
            rowList.Clear();
        }

        ms.Close();

        StateHasChanged();

        /*
        Regex regex = new Regex(".+\\.csv", RegexOptions.Compiled);  
        if (!regex.IsMatch(singleFile.Name))  
        {  
            //show error invalidad format file  
        }  
        else  
        {  
            var stream = singleFile.OpenReadStream();  
            var csv = new List<string[]>();  
            MemoryStream ms = new MemoryStream();  
            await stream.CopyToAsync(ms);  
            stream.Close();  
            var outputFileString = System.Text.Encoding.UTF8.GetString(ms.ToArray());  

            foreach (var item in outputFileString.Split(Environment.NewLine))  
            {  
                csv.Add(SplitCSV(item.ToString()));  
            }

            Console.Write(csv);

        }  

        */

        
        
        //TODO upload the files to the server
    }




}
